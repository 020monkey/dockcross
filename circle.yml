machine:
  # XXX: btrfs circleCI fix, see: https://github.com/docker/docker/issues/9939 and https://github.com/Sabayon/docker-stage3-base-amd64/commit/8c1bf737113a278dd2f
  pre:
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.0-circleci'
    - sudo chmod 0755 /usr/bin/docker
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"

  override:
    - docker info
    - if [[ -e ~/docker/base.tar ]]; then docker load -i ~/docker/base.tar; fi
    - docker pull dockcross/base
    - if [[ -e ~/docker/android-arm.tar ]]; then docker load -i ~/docker/android-arm.tar; fi
    - docker pull dockcross/android-arm
    - if [[ -e ~/docker/browser-asmjs.tar ]]; then docker load -i ~/docker/browser-asmjs.tar; fi
    - docker pull dockcross/browser-asmjs
    - if [[ -e ~/docker/linux-arm64.tar ]]; then docker load -i ~/docker/linux-arm64.tar; fi
    - docker pull dockcross/linux-arm64
    - if [[ -e ~/docker/linux-armv5.tar ]]; then docker load -i ~/docker/linux-armv5.tar; fi
    - docker pull dockcross/linux-armv5
    - if [[ -e ~/docker/linux-armv6.tar ]]; then docker load -i ~/docker/linux-armv6.tar; fi
    - docker pull dockcross/linux-armv6
    - if [[ -e ~/docker/linux-armv7.tar ]]; then docker load -i ~/docker/linux-armv7.tar; fi
    - docker pull dockcross/linux-armv7
    - if [[ -e ~/docker/linux-ppc64le.tar ]]; then docker load -i ~/docker/linux-ppc64le.tar; fi
    - docker pull dockcross/linux-ppc64le
    - if [[ -e ~/docker/linux-x64.tar ]]; then docker load -i ~/docker/linux-x64.tar; fi
    - docker pull dockcross/linux-x64
    - if [[ -e ~/docker/linux-x86.tar ]]; then docker load -i ~/docker/linux-x86.tar; fi
    - docker pull dockcross/linux-x86
    - if [[ -e ~/docker/manylinux-x64.tar ]]; then docker load -i ~/docker/manylinux-x64.tar; fi
    - docker pull dockcross/manylinux-x64
    - if [[ -e ~/docker/windows-x64.tar ]]; then docker load -i ~/docker/windows-x64.tar; fi
    - docker pull dockcross/windows-x64
    - if [[ -e ~/docker/windows-x86.tar ]]; then docker load -i ~/docker/windows-x86.tar; fi
    - docker pull dockcross/windows-x86

test:
  override:
    - make base.test
    - mkdir -p ~/docker; docker save dockcross/base > ~/docker/base.tar
    - make android-arm.test
    - mkdir -p ~/docker; docker save dockcross/android-arm > ~/docker/android-arm.tar
    - make browser-asmjs.test
    - mkdir -p ~/docker; docker save dockcross/browser-asmjs > ~/docker/browser-asmjs.tar
    - make linux-arm64.test
    - mkdir -p ~/docker; docker save dockcross/linux-arm64 > ~/docker/linux-arm64.tar
    - make linux-armv5.test
    - mkdir -p ~/docker; docker save dockcross/linux-armv5 > ~/docker/linux-armv5.tar
    - make linux-armv6.test
    - mkdir -p ~/docker; docker save dockcross/linux-armv6 > ~/docker/linux-armv6.tar
    - make linux-armv7.test
    - mkdir -p ~/docker; docker save dockcross/linux-armv7 > ~/docker/linux-armv7.tar
    - make linux-ppc64le.test
    - mkdir -p ~/docker; docker save dockcross/linux-ppc64le > ~/docker/linux-ppc64le.tar
    - make linux-x64.test
    - mkdir -p ~/docker; docker save dockcross/linux-x64 > ~/docker/linux-x64.tar
    - make linux-x86.test
    - mkdir -p ~/docker; docker save dockcross/linux-x86 > ~/docker/linux-x86.tar
    - make manylinux-x64.test
    - mkdir -p ~/docker; docker save dockcross/manylinux-x64 > ~/docker/manylinux-x64.tar
    - make windows-x64.test:
        timeout: 3000
    - mkdir -p ~/docker; docker save dockcross/windows-x64 > ~/docker/windows-x64.tar
    - make windows-x86.test:
        timeout: 3000
    - mkdir -p ~/docker; docker save dockcross/windows-x86 > ~/docker/windows-x86.tar

deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push dockcross/base
      - docker push dockcross/android-arm
      - docker push dockcross/browser-asmjs
      - docker push dockcross/linux-arm64
      - docker push dockcross/linux-armv5
      - docker push dockcross/linux-armv6
      - docker push dockcross/linux-armv7
      - docker push dockcross/linux-ppc64le
      - docker push dockcross/linux-x64
      - docker push dockcross/linux-x86
      - docker push dockcross/manylinux-x64
      - docker push dockcross/windows-x64
      - docker push dockcross/windows-x86
